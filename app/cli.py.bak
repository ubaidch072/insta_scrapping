from typing import Optional
from .browser import open_browser
from .scrape import fetch_profile_via_api

def run(query: Optional[str], username: Optional[str], headless: bool = True):
    """
    Entry used by the API. Opens a logged-in browser context, fetches the profile
    via Instagram's JSON endpoint, returns your usual response dict.
    """
    p, b, ctx, page = open_browser("storage_state.json", headless=headless)
    try:
        handle = username or query  # keep behavior: use username first, else try query
        data = fetch_profile_via_api(ctx, handle)
        return data or {}
    finally:
        b.close()
        p.stop()
